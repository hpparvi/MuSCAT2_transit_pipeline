#!/usr/bin/env python

#  MuSCAT2 photometry and transit analysis pipeline
#  Copyright (C) 2019  Hannu Parviainen
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <https://www.gnu.org/licenses/>.

import logging
import re
import itertools as it
from argparse import ArgumentParser
from multiprocessing import Pool
from os import remove, chdir
from pathlib import Path
from subprocess import run, PIPE, TimeoutExpired

import pandas as pd
from astropy.io import fits as pf
from numpy import nan, inf
from tqdm import tqdm

from muscat2ph.catalog import get_coords

TMPEXTS = ".match .axy .rdls .solved -indx.xyls .corr".split()
MAX_TIMEOUT = 60


def run_astrometry(filename_and_obj, overwrite=True):
    filename, object = filename_and_obj
    object = object or pf.getval(filename, 'object').lower()
    astcall = ["solve-field", "--overwrite", "--no-plots", "--new-fits=none", "--fits-image", '--downsample=2',
               "--scale-low=0.4", "--scale-high=0.5", "--scale-units=app"]

    sc = None
    try:
        sc = get_coords(object)
        astcall.extend([f"--ra={sc.ra.deg}", f"--dec={sc.dec.deg}", "--radius=0.15"])
        logging.info(f" Solving {filename.stem} - {object} - RA: {sc.ra.deg:6.3f} DEC: {sc.dec.deg:6.3f}")
    except:
        logging.info(f" Solving {filename.stem} - {object} - Not found from any catalog")

    astcall.append(str(filename))

    try:
        r = run(astcall, stdout=PIPE, stderr=PIPE, timeout=MAX_TIMEOUT)
        rout = r.stdout.decode()
    except TimeoutExpired:
        return str(filename), nan, nan, nan

    for ext in TMPEXTS:
        try:
            remove(filename.parent.joinpath(filename.stem + ext))
        except FileNotFoundError:
            pass

    try:
        center = list(map(float, re.findall('Field center: \(RA,Dec\) = \((.*),(.*)\)', rout)[0]))
        rotation = float(re.findall('Field rotation .* is (.*?) .*', rout)[0])
        logging.info(" Solved  {} {} - RA: {:6.3f} DEC: {:6.3f} Rotation: {:6.3f}".format(filename.stem, object, center[0], center[1], rotation))
        return str(filename), center[0], center[1], rotation
    except IndexError:
        logging.info(" Failed to solve {} {}".format(filename.stem, object))
        return str(filename), nan, nan, nan


def process_datadir(datadir, logdir, file_prefix, file_postfix, start_frame, end_frame, target_name=None):
    files = sorted(list(datadir.rglob("%s*%s"%(file_prefix, file_postfix))))
    istart = max(0, start_frame)
    iend = min(end_frame, len(files))
    files = files[istart:iend]
    f = files[0].absolute()

    target = str(f.parts[-3])
    pb = str(f.parts[-2])

    logging.basicConfig(filename=logdir.joinpath(f'00_m2astrometry_{target}_{pb}.log'), filemode='w', level=logging.DEBUG)

    files = list(zip(files, (it.repeat(target_name, len(files)))))

    with Pool(args.n_processes) as p:
        r = list(tqdm(p.imap(run_astrometry, files), total=len(files), desc='Solving astrometry for {} {}'.format(target, pb)))
        df = pd.DataFrame(r, columns='filename RA Dec rotation'.split())

    dfname = '01_m2astrometry_{}_{}.csv'.format(target, pb)
    df.to_csv(logdir.joinpath(dfname), index=False)


if __name__ == '__main__':
    ap = ArgumentParser()
    ap.add_argument('--root', type=Path, default=Path('.').absolute())
    ap.add_argument('--name-glob', type=str, default='*', help='glob pattern that is matched against the object name.')
    ap.add_argument('--directory', type=Path, default=None)
    ap.add_argument('--target-catalog-name', type=str, default=None)
    ap.add_argument('-n', '--n-processes', type=int, default=6)
    ap.add_argument('-f', '--overwrite', action='store_true', default=False)
    ap.add_argument('--file-prefix', type=str, default='MCT2')
    ap.add_argument('--file-postfix', type=str, default='.fits')
    ap.add_argument('--start-frame', type=int, default=0)
    ap.add_argument('--end-frame', type=int, default=inf)
    args = ap.parse_args()

    if args.directory is not None:
        process_datadir(args.directory, args.directory, args.file_prefix, args.file_postfix, args.start_frame, args.end_frame,
                        target_name=args.target_catalog_name)
    else:
        passbands = 'g r i z_s'.split()

        curdir = Path('.').absolute()
        objdir = args.root.joinpath('obj')

        if objdir.exists():
            targets = list(objdir.glob(args.name_glob))

            if args.target_catalog_name is not None and len(targets) > 1:
                print('Error: target catalog name given but processing more than one target.')
                exit()

            for tdir in targets:
                chdir(tdir.absolute())
                for pb in passbands:
                    datadir = tdir.joinpath(pb)
                    if datadir.exists():
                        process_datadir(datadir, tdir, args.file_prefix, args.file_postfix, args.start_frame, args.end_frame,
                                        target_name=args.target_catalog_name)
            chdir(curdir)
        else:
            print('Error: Could not find "obj" directory.')
